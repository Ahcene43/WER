// config.js - ملف الإعدادات المشترك
let STORE_CONFIG = {
  "PRODUCTS": {
    "1": {
      "name": "مودال 1",
      "price": 3300,
      "image": "https://i.ibb.co/wFhBNhmf/modal6-jpg.webp",
      "description": "تصميم مريح وعصري مع تفاصيل راقية تناسب جميع المناسبات",
      "availableColors": [
        "كما في الصورة"
      ],
      "availableSizes": [
        "M",
        "L"
      ]
    },
    "2": {
      "name": "مودال 14",
      "price": 5200,
      "image": "https://raw.githubusercontent.com/Ahcene43/Inas/main/images/1760731352265-modal6.jpg",
      "description": "مودال شتوي فاخر",
      "availableSizes": [
        "S",
        "M",
        "L",
        "XL",
        "XXL",
        "S1"
      ],
      "availableColors": [
        "كما في الصورة",
        "أبيض",
        "أسود",
        "رمادي"
      ]
    }
  },
  "DELIVERY_PRICES": {
    "01 - أدرار": {
      "home": 1100,
      "desk": 600
    },
    "02 - الشلف": {
      "home": 700,
      "desk": 400
    },
    "03 - الأغواط": {
      "home": 900,
      "desk": 500
    },
    "04 - أم البواقي": {
      "home": 650,
      "desk": 400
    },
    "05 - باتنة": {
      "home": 700,
      "desk": 400
    },
    "06 - بجاية": {
      "home": 700,
      "desk": 400
    },
    "07 - بسكرة": {
      "home": 900,
      "desk": 500
    },
    "08 - بشار": {
      "home": 1100,
      "desk": 600
    },
    "09 - البليدة": {
      "home": 500,
      "desk": 250
    },
    "10 - البويرة": {
      "home": 700,
      "desk": 400
    },
    "11 - تمنراست": {
      "home": 1300,
      "desk": 800
    },
    "12 - تبسة": {
      "home": 700,
      "desk": 400
    },
    "13 - تلمسان": {
      "home": 800,
      "desk": 400
    },
    "14 - تيارت": {
      "home": 800,
      "desk": 400
    },
    "15 - تيزي وزو": {
      "home": 700,
      "desk": 400
    },
    "16 - الجزائر": {
      "home": 500,
      "desk": 250
    },
    "17 - الجلفة": {
      "home": 900,
      "desk": 500
    },
    "18 - جيجل": {
      "home": 700,
      "desk": 400
    },
    "19 - سطيف": {
      "home": 700,
      "desk": 400
    },
    "20 - سعيدة": {
      "home": 800,
      "desk": 400
    },
    "21 - سكيكدة": {
      "home": 600,
      "desk": 400
    },
    "22 - سيدي بلعباس": {
      "home": 700,
      "desk": 400
    },
    "23 - عنابة": {
      "home": 700,
      "desk": 400
    },
    "24 - قالمة": {
      "home": 600,
      "desk": 400
    },
    "25 - قسنطينة": {
      "home": 600,
      "desk": 400
    },
    "26 - المدية": {
      "home": 700,
      "desk": 400
    },
    "27 - مستغانم": {
      "home": 700,
      "desk": 400
    },
    "28 - المسيلة": {
      "home": 800,
      "desk": 400
    },
    "29 - معسكر": {
      "home": 700,
      "desk": 400
    },
    "30 - ورقلة": {
      "home": 900,
      "desk": 500
    },
    "31 - وهران": {
      "home": 800,
      "desk": 400
    },
    "32 - البيض": {
      "home": 800,
      "desk": 500
    },
    "33 - إليزي": {
      "home": 1300,
      "desk": 600
    },
    "34 - برج بوعريريج": {
      "home": 700,
      "desk": 400
    },
    "35 - بومرداس": {
      "home": 700,
      "desk": 400
    },
    "36 - الطارف": {
      "home": 700,
      "desk": 400
    },
    "37 - تندوف": {
      "home": 1300,
      "desk": 600
    },
    "38 - تيسمسيلت": {
      "home": 800,
      "desk": 400
    },
    "39 - الوادي": {
      "home": 900,
      "desk": 500
    },
    "40 - خنشلة": {
      "home": 700,
      "desk": 500
    },
    "41 - سوق أهراس": {
      "home": 700,
      "desk": 400
    },
    "42 - تيبازة": {
      "home": 700,
      "desk": 400
    },
    "43 - ميلة": {
      "home": 500,
      "desk": 350
    },
    "44 - عين الدفلى": {
      "home": 700,
      "desk": 400
    },
    "45 - النعامة": {
      "home": 800,
      "desk": 500
    },
    "46 - عين تموشنت": {
      "home": 800,
      "desk": 400
    },
    "47 - غرداية": {
      "home": 900,
      "desk": 500
    },
    "48 - غليزان": {
      "home": 700,
      "desk": 400
    },
    "49 - تيميمون": {
      "home": 1100,
      "desk": 600
    },
    "50 - برج باجي مختار": {
      "home": 1200,
      "desk": 650
    },
    "51 - أولاد جلال": {
      "home": 900,
      "desk": 500
    },
    "52 - بني عباس": {
      "home": 1100,
      "desk": 600
    },
    "53 - عين صالح": {
      "home": 1300,
      "desk": 700
    },
    "54 - عين قزام": {
      "home": 1300,
      "desk": 700
    },
    "55 - توقرت": {
      "home": 950,
      "desk": 550
    },
    "56 - جانت": {
      "home": 1100,
      "desk": 500
    },
    "57 - المغير": {
      "home": 950,
      "desk": 550
    },
    "58 - المنيعة": {
      "home": 1000,
      "desk": 600
    }
  },
  "DISCOUNTS": {
    "minQuantityForDiscount": 3,
    "discountPerItem": 300
  },
  "STORE_INFO": {
    "name": "RIHAB12-Shopp",
    "tagline": "متجر أفخم الملابس",
    "phoneNumbers": [
      "0671466489",
      "0551102155"
    ]
  },
  "AGE_SIZES": {
    "6": "S1",
    "7": "S",
    "8": "M",
    "9": "L",
    "10": "XL",
    "11": "XXL",
    "12": "S4"
  },
  "AVAILABLE_COLORS": [
    "كما في الصورة",
    "أبيض",
    "أسود",
    "رمادي",
    "أزرق",
    "أحمر",
    "أخضر",
    "زهري",
    "بنفسجي"
  ],
  "AVAILABLE_SIZES": [
    "S",
    "M",
    "L",
    "XL",
    "XXL",
    "S1"
  ]
};

// دالة محسنة لتحميل الإعدادات من GitHub
async function loadRemoteConfig(tokenConfig = null, repo = null) {
  try {
    let configUrl;
    
    if (tokenConfig && repo) {
      configUrl = `https://raw.githubusercontent.com/${tokenConfig.username}/${repo}/${tokenConfig.branch || 'main'}/config.json?t=${Date.now()}`;
    } else {
      configUrl = 'https://raw.githubusercontent.com/Ahcene43/WAW/main/config.json?t=' + Date.now();
    }
    
    console.log('🔄 جاري تحميل الإعدادات من:', configUrl);
    const response = await fetch(configUrl);
    
    if (response.ok) {
      const remoteConfig = await response.json();
      STORE_CONFIG = remoteConfig;
      saveConfig(STORE_CONFIG);
      console.log('✅ تم تحميل الإعدادات من GitHub');
      
      // إطلاق حدث مخصص للتحديث
      window.dispatchEvent(new CustomEvent('configUpdated', { detail: STORE_CONFIG }));
      
      return true;
    }
  } catch (error) {
    console.log('⚠️ استخدام الإعدادات المحلية بسبب الخطأ:', error);
  }
  return false;
}

// تحميل الإعدادات المحفوظة محلياً
function loadConfig() {
  const saved = localStorage.getItem('storeConfig');
  if (saved) {
    try {
      const parsedConfig = JSON.parse(saved);
      STORE_CONFIG = parsedConfig;
      console.log('📂 تم تحميل الإعدادات المحلية');
    } catch (e) {
      console.error('Error loading config:', e);
    }
  }
  return STORE_CONFIG;
}

// حفظ الإعدادات محلياً
function saveConfig(config = STORE_CONFIG) {
  try {
    localStorage.setItem('storeConfig', JSON.stringify(config));
    STORE_CONFIG = config;
    console.log('💾 تم حفظ الإعدادات محلياً');
  } catch (error) {
    console.error('Error saving config locally:', error);
  }
}

// دالة محسنة للحفظ على GitHub
async function saveToGitHub(config, tokenConfig, repo) {
  try {
    if (!tokenConfig || !tokenConfig.token || !tokenConfig.username || !repo) {
      throw new Error('إعدادات GitHub غير مكتملة');
    }

    const content = btoa(unescape(encodeURIComponent(JSON.stringify(config, null, 2))));
    const branch = tokenConfig.branch || 'main';
    
    console.log('🔼 محاولة الحفظ على GitHub:', { repo, branch, username: tokenConfig.username });
    
    // محاولة الحصول على الـ SHA للملف الموجود
    let sha = '';
    try {
      const existingFileResponse = await fetch(
        `https://api.github.com/repos/${tokenConfig.username}/${repo}/contents/config.json`,
        {
          headers: {
            'Authorization': `token ${tokenConfig.token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        }
      );
      
      if (existingFileResponse.ok) {
        const fileData = await existingFileResponse.json();
        sha = fileData.sha;
        console.log('📁 وجدنا ملف موجود، سيتم تحديثه');
      }
    } catch (error) {
      console.log('📄 سيتم إنشاء ملف جديد');
    }

    const response = await fetch(
      `https://api.github.com/repos/${tokenConfig.username}/${repo}/contents/config.json`,
      {
        method: 'PUT',
        headers: {
          'Authorization': `token ${tokenConfig.token}`,
          'Content-Type': 'application/json',
          'Accept': 'application/vnd.github.v3+json'
        },
        body: JSON.stringify({
          message: 'تحديث إعدادات المتجر - ' + new Date().toLocaleString('ar-EG'),
          content: content,
          sha: sha,
          branch: branch
        })
      }
    );

    if (!response.ok) {
      const errorData = await response.json();
      const errorMsg = errorData.message || `فشل في حفظ الإعدادات على GitHub: ${response.status}`;
      console.error('❌ خطأ في الحفظ على GitHub:', errorMsg);
      throw new Error(errorMsg);
    }

    const result = await response.json();
    console.log('✅ تم الحفظ على GitHub بنجاح:', result);
    return result;
  } catch (error) {
    console.error('❌ Error saving to GitHub:', error);
    throw error;
  }
}

// دالة محسنة لتحميل الإعدادات مع التوكن
async function loadRemoteConfigWithToken(tokenConfig, repo) {
  return await loadRemoteConfig(tokenConfig, repo);
}

// تحميل الإعدادات عند استيراد الملف
loadConfig();

// محاولة تحميل الإعدادات من الخادم بعد تحميل الصفحة
setTimeout(() => {
  loadRemoteConfig();
}, 1000);

// التحقق من التحديثات كل دقيقة
setInterval(() => {
  console.log('🔄 التحقق من التحديثات...');
  loadRemoteConfig();
}, 60000);
